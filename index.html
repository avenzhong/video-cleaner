<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>去水印下载</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: 247 247 248;
      --fg: 17 24 39;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: 17 17 20;
        --fg: 229 231 235;
      }
    }

    body {
      background-color: rgb(var(--bg));
      color: rgb(var(--fg));
    }
  </style>
  <script src="config.js"></script>
</head>

<body class="min-h-screen">
  <!-- 密码层 -->
  <div id="gate" class="fixed inset-0 flex items-center justify-center bg-black/60">
    <div class="w-[min(92vw,420px)] rounded-2xl bg-white dark:bg-neutral-900 shadow-xl p-6 space-y-4">
      <h1 class="text-xl font-semibold">进入页面</h1>
      <p class="text-sm text-neutral-500">本页暂不开放注册登录，使用固定密码访问。</p>
      <label class="block text-sm font-medium">密码</label>
      <input id="pwd" type="password"
        class="w-full rounded-xl border border-neutral-200 dark:border-neutral-700 bg-transparent px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        placeholder="输入密码（123456）" />
      <button id="enterBtn"
        class="w-full rounded-xl bg-indigo-600 text-white py-2.5 font-medium hover:bg-indigo-500 active:scale-[.99]">进入</button>
      <p id="gateMsg" class="text-sm text-rose-500"></p>
    </div>
  </div>

  <!-- 应用主体 -->
  <header class="mx-auto max-w-4xl px-4 pt-8 pb-4">
    <h1 class="text-2xl font-bold tracking-tight">去水印下载</h1>
    <p class="text-sm text-neutral-500 mt-1">粘贴任意混杂文本，我会自动 <span class="font-medium">正则提取</span> 第一个
      <code>http(s)</code> 链接并解析。
    </p>
  </header>

  <main class="mx-auto max-w-4xl px-4 pb-16">
    <section
      class="rounded-2xl bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 shadow-sm p-4 md:p-6 space-y-4">
      <div class="space-y-2">
        <label for="rawInput" class="block text-sm font-medium">粘贴分享文案 / 链接</label>
        <textarea id="rawInput"
          class="w-full h-32 rounded-xl border border-neutral-200 dark:border-neutral-700 bg-transparent px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="示例：4.89 03/24 cNJ:/ K@W.md 随意… https://v.douyin.com/ZOqdo9qsYuY/ 复制此链接…"></textarea>
        <div class="flex items-center gap-2 text-xs text-neutral-500">
          <span>将自动提取第一个 URL →</span>
          <code id="extracted" class="px-2 py-0.5 rounded bg-neutral-100 dark:bg-neutral-800">(尚未提取)</code>
          <button id="copyUrlBtn"
            class="ml-auto inline-flex items-center gap-1 rounded-lg border border-neutral-200 dark:border-neutral-700 px-2.5 py-1 hover:bg-neutral-50 dark:hover:bg-neutral-800">复制URL</button>
        </div>
      </div>

      <div class="flex items-center justify-between gap-3">
        <button id="parseBtn"
          class="w-full rounded-xl bg-indigo-600 text-white py-2.5 font-medium hover:bg-indigo-500 active:scale-[.99]">开始解析</button>
      </div>

      <p id="hint" class="text-xs text-neutral-500">接口：<code>/api/waterremove?link=解析到的URL</code>（服务端代理，避免泄露 ak）</p>
      <p id="status" class="text-sm text-neutral-500"></p>
    </section>

    <!-- 解析结果 -->
    <section id="resultCard"
      class="mt-6 hidden rounded-2xl bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 shadow-sm overflow-hidden">
      <div class="p-4 md:p-6 space-y-4">
        <div class="flex items-start gap-4">
          <img id="coverImg" src="" alt="封面"
            class="w-28 h-16 object-cover rounded-lg border border-neutral-200 dark:border-neutral-800" />
          <div class="min-w-0">
            <h2 id="title" class="font-semibold text-lg truncate">—</h2>
            <div class="text-xs text-neutral-500 space-x-2 mt-1">
              <span>类型：<span id="type">—</span></span>
              <span>作者：<span id="author">—</span></span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label class="text-sm font-medium">视频地址</label>
            <input id="videoUrl"
              class="w-full rounded-xl border border-neutral-200 dark:border-neutral-700 bg-transparent px-3 py-2 text-sm"
              readonly />
            <div class="flex gap-2">
              <button id="copyVideoBtn"
                class="rounded-lg border border-neutral-200 dark:border-neutral-700 px-3 py-1.5 text-sm hover:bg-neutral-50 dark:hover:bg-neutral-800">复制地址</button>
              <button id="dlVideoBtn"
                class="rounded-lg bg-indigo-600 text-white px-3 py-1.5 text-sm hover:bg-indigo-500">下载视频</button>
            </div>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">封面地址</label>
            <input id="coverUrl"
              class="w-full rounded-xl border border-neutral-200 dark:border-neutral-700 bg-transparent px-3 py-2 text-sm"
              readonly />
            <div class="flex gap-2">
              <button id="copyCoverBtn"
                class="rounded-lg border border-neutral-200 dark:border-neutral-700 px-3 py-1.5 text-sm hover:bg-neutral-50 dark:hover:bg-neutral-800">复制地址</button>
              <button id="dlCoverBtn"
                class="rounded-lg bg-neutral-800 text-white px-3 py-1.5 text-sm hover:bg-neutral-700">下载封面</button>
            </div>
          </div>
        </div>

        <details class="mt-2 text-sm text-neutral-500">
          <summary class="cursor-pointer select-none">查看更多字段</summary>
          <pre id="rawJson" class="mt-2 overflow-auto text-xs bg-neutral-50 dark:bg-neutral-800 rounded-lg p-3"></pre>
        </details>
      </div>
    </section>

    <p class="mt-6 text-[12px] text-neutral-500">提示：请确保你对所下载内容拥有合法权利，并遵守平台服务条款与当地法律法规。</p>
  </main>

  <script>
    // —— 密码门禁 ——
    (function gateKeeper() {
      const PASS = "123456"; // 固定密码
      const gate = document.getElementById('gate');
      const pwd = document.getElementById('pwd');
      const btn = document.getElementById('enterBtn');
      const msg = document.getElementById('gateMsg');
      function enter() {
        if (pwd.value === PASS) { gate.classList.add('hidden'); }
        else { msg.textContent = '密码错误'; pwd.focus(); }
      }
      btn.addEventListener('click', enter);
      pwd.addEventListener('keydown', e => { if (e.key === 'Enter') { enter(); } });
    })();

    // —— 工具函数 ——
    const $ = (id) => document.getElementById(id);
    function firstHttpUrl(text) {
      if (!text) return '';
      const match = text.match(/https?:\/\/[\w\-._~:/?#\[\]@!$&'()*+,;=%]+/i);
      return match ? match[0].replace(/\u200b|\u2006|\s+$/g, '').replace(/"|'|\)$/, '') : '';
    }
    async function downloadFile(url, filename) {
      try {
        const u = new URL(url);
        // 对跨域资源优先采用“直接导航/新标签下载”，规避 CORS 403
        if (u.origin !== location.origin) {
          const a = document.createElement('a');
          a.href = url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          // download 对跨域可能被忽略，但不影响新标签下载
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          return;
        }
        // 同源时走 blob 方式
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      } catch (e) {
        // 兜底：仍然尝试在新标签打开
        try { window.open(url, '_blank', 'noopener'); }
        catch (_) { }
        throw e;
      }
    }

    // —— DOM 元素 ——
    const rawInput = $('rawInput');
    const extracted = $('extracted');
    const copyUrlBtn = $('copyUrlBtn');
    const parseBtn = $('parseBtn');
    const statusEl = $('status');

    const resultCard = $('resultCard');
    const coverImg = $('coverImg');
    const titleEl = $('title');
    const typeEl = $('type');
    const authorEl = $('author');
    const videoUrlEl = $('videoUrl');
    const coverUrlEl = $('coverUrl');
    const copyVideoBtn = $('copyVideoBtn');
    const copyCoverBtn = $('copyCoverBtn');
    const dlVideoBtn = $('dlVideoBtn');
    const dlCoverBtn = $('dlCoverBtn');
    const rawJsonEl = $('rawJson');

    // —— 输入时自动提取 URL ——
    function updateExtract() {
      const url = firstHttpUrl(rawInput.value);
      extracted.textContent = url || '(尚未提取)';
    }
    rawInput.addEventListener('input', updateExtract);
    updateExtract();

    copyUrlBtn.addEventListener('click', async () => {
      const url = extracted.textContent;
      if (!url || url === '(尚未提取)') return;
      await navigator.clipboard.writeText(url);
      copyUrlBtn.textContent = '已复制';
      setTimeout(() => copyUrlBtn.textContent = '复制URL', 1200);
    });

    // —— 解析按钮 ——
    parseBtn.addEventListener('click', async () => {
      const link = firstHttpUrl(rawInput.value);
      if (!link) { statusEl.textContent = '未检测到 URL，请粘贴包含 http/https 的文本'; return; }

      const endpoint = `${location.origin}/api/waterremove?link=${encodeURIComponent(link)}&_ts=${Date.now()}`;

      statusEl.textContent = '解析中…';
      parseBtn.disabled = true; parseBtn.textContent = '解析中…';

      try {
        const res = await fetch(endpoint, { cache: 'no-store' });
        let data;
        if (res.status === 304) {
          const res2 = await fetch(`${endpoint}&_=${Date.now()}`, { cache: 'no-store' });
          if (!res2.ok) throw new Error('HTTP ' + res2.status);
          data = await res2.json();
        } else {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          data = await res.json();
        }
        rawJsonEl.textContent = JSON.stringify(data, null, 2);

        if (data.code !== '10000' || !data.content || data.content.success === false) {
          throw new Error(data.msg || '解析失败');
        }
        const c = data.content;
        titleEl.textContent = c.title || '—';
        typeEl.textContent = c.type || '—';
        authorEl.textContent = c.author || '—';

        videoUrlEl.value = c.url || '';
        coverUrlEl.value = c.cover || '';
        coverImg.src = c.cover || '';

        resultCard.classList.remove('hidden');
        statusEl.textContent = '解析成功';
      } catch (err) {
        console.error(err);
        statusEl.textContent = '解析出错：' + err.message;
      } finally {
        parseBtn.disabled = false; parseBtn.textContent = '开始解析';
      }
    });

    // —— 复制与下载 ——
    copyVideoBtn.addEventListener('click', async () => {
      if (!videoUrlEl.value) return;
      await navigator.clipboard.writeText(videoUrlEl.value);
      copyVideoBtn.textContent = '已复制';
      setTimeout(() => copyVideoBtn.textContent = '复制地址', 1200);
    });
    copyCoverBtn.addEventListener('click', async () => {
      if (!coverUrlEl.value) return;
      await navigator.clipboard.writeText(coverUrlEl.value);
      copyCoverBtn.textContent = '已复制';
      setTimeout(() => copyCoverBtn.textContent = '复制地址', 1200);
    });

    dlVideoBtn.addEventListener('click', async () => {
      const url = videoUrlEl.value;
      if (!url) return;
      const dl = `${location.origin}/api/download?url=${encodeURIComponent(url)}&filename=${encodeURIComponent('video.mp4')}`;
      dlVideoBtn.textContent = '下载中…'; dlVideoBtn.disabled = true;
      try {
        // 直接新开下载（避免被浏览器拦截，尽量由用户手势触发）
        window.open(dl, '_blank', 'noopener');
      } catch (e) {
        alert('下载失败：' + (e?.message || e));
      } finally {
        dlVideoBtn.textContent = '下载视频'; dlVideoBtn.disabled = false;
      }
    });

    dlCoverBtn.addEventListener('click', async () => {
      const url = coverUrlEl.value;
      if (!url) return;
      const dl = `${location.origin}/api/download?url=${encodeURIComponent(url)}&filename=${encodeURIComponent('cover.jpg')}`;
      dlCoverBtn.textContent = '下载中…'; dlCoverBtn.disabled = true;
      try {
        window.open(dl, '_blank', 'noopener');
      } catch (e) {
        alert('下载失败：' + (e?.message || e));
      } finally {
        dlCoverBtn.textContent = '下载封面'; dlCoverBtn.disabled = false;
      }
    });
  </script>
</body>

</html>